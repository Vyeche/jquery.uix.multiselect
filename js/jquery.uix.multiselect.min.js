/*
 * jQuery UIx Multiselect 2.0
 *
 * Authors:
 *  Yanick Rochon (yanick.rochon[at]gmail[dot]com)
 *
 * Licensed under the MIT (MIT-LICENSE.txt) license.
 *
 * http://mind2soft.com/labs/jquery/multiselect/
 *
 *
 * Depends:
 * jQuery UI 1.8+
 *
 */

;(function($,window,undefined){"use strict";var globalScope=0;var DEF_OPTGROUP='';var PRE_OPTGROUP='group-';var EVENT_CHANGE='multiselectChange';var EVENT_SEARCH='multiselectSearch';$.widget("uix.multiselect",{options:{availableListPosition:'right',collapsableGroups:true,created:null,defaultGroupName:'',filterSelected:false,locale:'auto',moveEffect:null,moveEffectOptions:{},moveEffectSpeed:null,optionRenderer:false,optionGroupRenderer:false,searchField:'toggle',searchFilter:null,searchHeader:'available',selectionMode:'click,d&d',showDefaultGroupHeader:false,showEmptyGroups:false,splitRatio:0.55,sortable:false,sortMethod:null},_create:function(){var that=this;var selListHeader,selListContent,avListHeader,avListContent;var btnSelectAll,btnDeselectAll;this.scope='multiselect'+(globalScope++);this.optionGroupIndex=1;this._setLocale(this.options.locale);this.element.addClass('uix-multiselect-original');this._elementWrapper=$('<div></div>').addClass('uix-multiselect ui-widget').css({'width':this.element.outerWidth(),'height':this.element.outerHeight()}).append($('<div></div>').addClass('multiselect-selected-list').append($('<div></div>').addClass('ui-widget-header').append(btnDeselectAll=$('<button></button>',{type:"button"}).addClass('uix-control-right').attr('data-localekey','deselectAll').attr('title',this._t('deselectAll')).button({icons:{primary:'ui-icon-arrowthickstop-1-e'},text:false}).click(function(e){e.preventDefault();e.stopPropagation();that.optionCache.setSelectedAll(false);return false;})).append(selListHeader=$('<div></div>').addClass('header-text'))).append(selListContent=$('<div></div>').addClass('uix-list-container ui-widget-content')))
['right,top'.indexOf(this.options.availableListPosition)>=0?'prepend':'append']($('<div></div>').addClass('multiselect-available-list').append($('<div></div>').addClass('ui-widget-header').append(btnSelectAll=$('<button></button>',{type:"button"}).addClass('uix-control-right').attr('data-localekey','selectAll').attr('title',this._t('selectAll')).button({icons:{primary:'ui-icon-arrowthickstop-1-w'},text:false}).click(function(e){e.preventDefault();e.stopPropagation();that.optionCache.setSelectedAll(true);return false;})).append(avListHeader=$('<div></div>').addClass('header-text'))).append(avListContent=$('<div></div>').addClass('uix-list-container ui-widget-content'))).insertAfter(this.element);this._buttons={'selectAll':btnSelectAll,'deselectAll':btnDeselectAll};this._headers={'selected':selListHeader,'available':avListHeader};this._lists={'selected':selListContent.attr('id',this.scope+'_selListContent'),'available':avListContent.attr('id',this.scope+'_avListContent')};this.optionCache=new OptionCache(this);this._searchDelayed=new SearchDelayed(this,{delay:500});this._initSearchable();this._applyListDroppable();this.refresh(this.options.created);},refresh:function(callback){this._resize();AsyncFunction(function(){this.optionCache.cleanup();var opt,options=this.element[0].childNodes;for(var i=0,l1=options.length;i<l1;i++){opt=options[i];if(opt.nodeType===1){if(opt.tagName.toUpperCase()==='OPTGROUP'){var optGroup=$(opt).data('option-group')||(PRE_OPTGROUP+(this.optionGroupIndex++));var grpOptions=opt.childNodes;this.optionCache.prepareGroup($(opt),optGroup);for(var j=0,l2=grpOptions.length;j<l2;j++){opt=grpOptions[j];if(opt.nodeType===1){this.optionCache.prepareOption($(opt),optGroup);}}}else{this.optionCache.prepareOption($(opt));}}}
this.optionCache.reIndex();if(this._searchField&&this._searchField.is(':visible')){this._search(null,true);}
if(callback)callback();},10,this);},search:function(options){if(typeof options!='object'){options={showInput:true,text:options};}
if((options.toggleInput!=false)&&!this._searchField.is(':visible')){this._buttons.search.trigger('click');}
this._search(options.text,!!options.silent);},locale:function(locale){if(locale===undefined){return this.options.locale;}else{this._setLocale(locale);this._updateControls();this._updateHeaders();}},_destroy:function(){this.optionCache.reset(true);this._lists['selected'].empty().remove();this._lists['available'].empty().remove();this._elementWrapper.empty().remove();delete this.optionCache;delete this._searchDelayed;delete this._lists;delete this._elementWrapper;this.element.removeClass('uix-multiselect-original');},_initSearchable:function(){var isToggle=('toggle'===this.options.searchField);var searchHeader=this.options.searchHeader;if(isToggle){var that=this;this._buttons['search']=$('<button></button',{type:"button"}).addClass('uix-control-right').attr('data-localekey','search').attr('title',this._t('search')).button({icons:{primary:'ui-icon-search'},text:false}).click(function(e){e.preventDefault();e.stopPropagation();if(that._searchField.is(':visible')){var b=$(this);that._headers[searchHeader].css('visibility','visible').fadeTo('fast',1.0);that._searchField.hide('slide',{direction:'right'},200,function(){b.removeClass('ui-corner-right ui-state-active').addClass('ui-corner-all');});that._searchDelayed.cancelLastRequest();that.optionCache.filter('');}else{that._headers[searchHeader].fadeTo('fast',0.1,function(){$(this).css('visibility','hidden');});$(this).removeClass('ui-corner-all').addClass('ui-corner-right ui-state-active');that._searchField.show('slide',{direction:'right'},200,function(){$(this).focus();});that._search();}
return false;}).insertBefore(this._headers[searchHeader]);}
if(this.options.searchField){if(!isToggle){this._headers[searchHeader].hide();}
this._searchField=$('<input type="text" />').addClass('uix-search ui-widget-content ui-corner-'+(isToggle?'left':'all'))[isToggle?'hide':'show']().insertBefore(this._headers[searchHeader]).focus(function(){$(this).select();}).on("keydown keypress",function(e){if(e.keyCode==13){e.preventDefault();e.stopPropagation();return false;}}).keyup($.proxy(this._searchDelayed.request,this._searchDelayed));}},_applyListDroppable:function(){if(this.options.selectionMode.indexOf('d&d')==-1)return;var _optionCache=this.optionCache;var currentScope=this.scope;var getElementData=function(d){return _optionCache._elements[d.data('element-index')];};var initDroppable=function(e,s){e.droppable({accept:function(draggable){var eData=getElementData(draggable);return eData&&(eData.selected!=s);},activeClass:'ui-state-highlight',scope:currentScope,drop:function(evt,ui){ui.draggable.removeClass('ui-state-disabled');ui.helper.remove();_optionCache.setSelected(getElementData(ui.draggable),s);}});}
initDroppable(this._lists['selected'],true);initDroppable(this._lists['available'],false);if(this.options.sortable){var that=this;this._lists['selected'].sortable({appendTo:'parent',axis:"y",containment:$('.multiselect-selected-list',this._elementWrapper),items:'.multiselect-element-wrapper',handle:'.group-element',revert:true,stop:$.proxy(function(evt,ui){var prevGroup;$('.multiselect-element-wrapper',that._lists['selected']).each(function(){var currGroup=that.optionCache._groups.get($(this).data('option-group'));if(!prevGroup){that.element.append(currGroup.groupElement);}else{currGroup.groupElement.insertAfter(prevGroup.groupElement);}
prevGroup=currGroup;});},this)});}},_search:function(term,silent){if(this._searchField.is(':visible')){if(typeof term==="string"){this._searchField.val(term);}else{term=this._searchField.val();}}
this.optionCache.filter(term,silent);},_setLocale:function(locale){if(locale=='auto'){locale=navigator.userLanguage||navigator.language||navigator.browserLanguage||navigator.systemLanguage||'';}
if(!$.uix.multiselect.i18n[locale]){locale='';}
this.options.locale=locale;},_t:function(key,plural,data){return _({locale:this.options.locale,key:key,plural:plural,data:data});},_updateControls:function(){var that=this;$('.uix-control-left,.uix-control-right',this._elementWrapper).each(function(){$(this).attr('title',that._t($(this).attr('data-localekey')));});},_updateHeaders:function(){var t,info=this.optionCache.getSelectionInfo();this._headers['selected'].text(t=this._t('itemsSelected',info.selected.total,{count:info.selected.total})).parent().attr('title',this.options.filterSelected?this._t('itemsSelected',info.selected.count,{count:info.selected.count})+", "+
this._t('itemsFiltered',info.selected.filtered,{count:info.selected.filtered}):t);this._headers['available'].text(this._t('itemsAvailable',info.available.total,{count:info.available.total})).parent().attr('title',this._t('itemsAvailable',info.available.count,{count:info.available.count})+", "+
this._t('itemsFiltered',info.available.filtered,{count:info.available.filtered}));},_resize:function(){var pos=this.options.availableListPosition.toLowerCase();var sSize=('left,right'.indexOf(pos)>=0)?'Width':'Height';var tSize=('left,right'.indexOf(pos)>=0)?'Height':'Width';var cSl=this.element['outer'+sSize]()*this.options.splitRatio;var cAv=this.element['outer'+sSize]()-cSl;var hSl=(tSize==='Width')?cSl:this.element.outerHeight();var hAv=(tSize==='Width')?cAv:this.element.outerHeight();var styleRule=('left,right'.indexOf(pos)>=0)?'left':'top';var swap=('left,top'.indexOf(pos)>=0);var isToggle=('toggle'===this.options.searchField);var headerBordersBoth='ui-corner-tl ui-corner-tr ui-corner-bl ui-corner-br ui-corner-top';var hSlCls=(tSize==='Width')?(swap?'':'ui-corner-top'):(swap?'ui-corner-tr':'ui-corner-tl');var hAvCls=(tSize==='Width')?(swap?'ui-corner-top':''):(swap?'ui-corner-tl':'ui-corner-tr');this._elementWrapper.find('.multiselect-available-list')
[sSize.toLowerCase()](cAv).css(styleRule,swap?0:cSl)
[tSize.toLowerCase()](this.element['outer'+tSize]()+1);this._elementWrapper.find('.multiselect-selected-list')
[sSize.toLowerCase()](cSl).css(styleRule,swap?cAv:0)
[tSize.toLowerCase()](this.element['outer'+tSize]()+1);this._buttons['selectAll'].button('option','icons',{primary:transferIcon(pos,'ui-icon-arrowthickstop-1-',false)});this._buttons['deselectAll'].button('option','icons',{primary:transferIcon(pos,'ui-icon-arrowthickstop-1-',true)});this._headers['available'].parent().removeClass(headerBordersBoth).addClass(hAvCls);this._headers['selected'].parent().removeClass(headerBordersBoth).addClass(hSlCls);if(!isToggle){var h=Math.max(this._headers['selected'].parent().height(),this._headers['available'].parent().height());this._headers['available'].parent().height(h);this._headers['selected'].parent().height(h);}
if(this._searchField){this._searchField.width((sSize==='Width'?cAv:this.element.width())-(isToggle?52:26));}
this._lists['available'].height(hAv-this._headers['available'].parent().outerHeight()-2);this._lists['selected'].height(hSl-this._headers['selected'].parent().outerHeight()-2);},_triggerUIEvent:function(event,ui){var eventType;if(typeof event==='string'){eventType=event;event=$.Event(event);}else{eventType=event.type;}
this.element.trigger(event,ui);return!event.isDefaultPrevented();},_setOption:function(key,value){switch(key){}
if(typeof(this._superApply)=='function'){this._superApply(arguments);}else{$.Widget.prototype._setOption.apply(this,arguments);}}});var ItemComparators={standard:function(a,b){if(a>b)return 1;if(a<b)return-1;return 0;},natural:function naturalSort(a,b){var re=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,sre=/(^[ ]*|[ ]*$)/g,dre=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,hre=/^0x[0-9a-f]+$/i,ore=/^0/,i=function(s){return naturalSort.insensitive&&(''+s).toLowerCase()||''+s},x=i(a).replace(sre,'')||'',y=i(b).replace(sre,'')||'',xN=x.replace(re,'\0$1\0').replace(/\0$/,'').replace(/^\0/,'').split('\0'),yN=y.replace(re,'\0$1\0').replace(/\0$/,'').replace(/^\0/,'').split('\0'),xD=parseInt(x.match(hre))||(xN.length!=1&&x.match(dre)&&Date.parse(x)),yD=parseInt(y.match(hre))||xD&&y.match(dre)&&Date.parse(y)||null,oFxNcL,oFyNcL;if(yD)
if(xD<yD)return-1;else if(xD>yD)return 1;for(var cLoc=0,numS=Math.max(xN.length,yN.length);cLoc<numS;cLoc++){oFxNcL=!(xN[cLoc]||'').match(ore)&&parseFloat(xN[cLoc])||xN[cLoc]||0;oFyNcL=!(yN[cLoc]||'').match(ore)&&parseFloat(yN[cLoc])||yN[cLoc]||0;if(isNaN(oFxNcL)!==isNaN(oFyNcL)){return(isNaN(oFxNcL))?1:-1;}
else if(typeof oFxNcL!==typeof oFyNcL){oFxNcL+='';oFyNcL+='';}
if(oFxNcL<oFyNcL)return-1;if(oFxNcL>oFyNcL)return 1;}
return 0;}};var transferDir=['n','e','s','w'];var transferOrientation=['bottom','left','top','right'];var transferIcon=function(pos,prefix,selected){return prefix+transferDir[($.inArray(pos.toLowerCase(),transferOrientation)+(selected?2:0))%4];};var AsyncFunction=function(callback,timeout,self){var args=Array.prototype.slice.call(arguments,3);return setTimeout(function(){callback.apply(self||window,args);},timeout);};var SearchDelayed=function(widget,options){this._widget=widget;this._options=options;this._lastSearchValue=null;};SearchDelayed.prototype={request:function(){if(this._widget._searchField.val()==this._lastSearchValue)return;this.cancelLastRequest();this._timeout=AsyncFunction(function(){this._timeout=null;this._lastSearchValue=this._widget._searchField.val();this._widget._search();},this._options.delay,this);},cancelLastRequest:function(){if(this._timeout){clearTimeout(this._timeout);}}};var GroupCache=function(comp){var keys=[];var items={};var comparator=comp;this.setComparator=function(comp){comparator=comp;return this;};this.clear=function(){keys=[];items={};return this;};this.containsKey=function(key){return!!items[key];};this.get=function(key){return items[key];};this.put=function(key,val){if(!items[key]){if(comparator){keys.splice((function(){var low=0,high=keys.length;var mid=-1,c=0;while(low<high){mid=parseInt((low+high)/2);var a=items[keys[mid]].groupElement;var b=val.groupElement;c=comparator(a?a.attr('label'):DEF_OPTGROUP,b?b.attr('label'):DEF_OPTGROUP);if(c<0){low=mid+1;}else if(c>0){high=mid;}else{return mid;}}
return low;})(),0,key);}else{keys.push(key);}}
items[key]=val;return this;};this.remove=function(key){delete items[key];return keys.splice(keys.indexOf(key),1);};this.each=function(callback){var args=Array.prototype.slice.call(arguments,1);args.splice(0,0,null,null);for(var i=0,len=keys.length;i<len;i++){args[0]=keys[i];args[1]=items[keys[i]];callback.apply(args[1],args);}
return this;};};var OptionCache=function(widget){this._widget=widget;this._listContainers={'selected':$('<div></div>').appendTo(this._widget._lists['selected']),'available':$('<div></div>').appendTo(this._widget._lists['available'])};this._elements=[];this._groups=new GroupCache();this._moveEffect={fn:widget.options.moveEffect,options:widget.options.moveEffectOptions,speed:widget.options.moveEffectSpeed};this._selectionMode=this._widget.options.selectionMode.indexOf('dblclick')>-1?'dblclick':this._widget.options.selectionMode.indexOf('click')>-1?'click':false;this.reset();};OptionCache.Options={batchCount:200,batchDelay:50};OptionCache.prototype={_createGroupElement:function(grpElement,optGroup,selected){var that=this;var gData;var getLocalData=function(){if(!gData)gData=that._groups.get(optGroup);return gData;};var getGroupName=function(){return grpElement?grpElement.attr('label'):that._widget.options.defaultGroupName;};var labelCount=$('<span></span>').addClass('label').text(getGroupName()+' (0)').attr('title',getGroupName()+' (0)');var fnUpdateCount=function(){var gDataDst=getLocalData()[selected?'selected':'available'];gDataDst.listElement[(!selected&&(gDataDst.count||that._widget.options.showEmptyGroups))||(gDataDst.count&&((gData.optionGroup!=DEF_OPTGROUP)||that._widget.options.showDefaultGroupHeader))?'show':'hide']();var t=getGroupName()+' ('+gDataDst.count+')';labelCount.text(t).attr('title',t);};var e=$('<div></div>').addClass('ui-widget-header ui-priority-secondary group-element').append($('<button></button>',{type:"button"}).addClass('uix-control-right').attr('data-localekey',(selected?'de':'')+'selectAllGroup').attr('title',this._widget._t((selected?'de':'')+'selectAllGroup')).button({icons:{primary:transferIcon(this._widget.options.availableListPosition,'ui-icon-arrowstop-1-',selected)},text:false}).click(function(e){e.preventDefault();e.stopPropagation();var gDataDst=getLocalData()[selected?'selected':'available'];if(gData.count>0){var _transferedOptions=[];that._bufferedMode(true);for(var i=gData.startIndex,len=gData.startIndex+gData.count,eData;i<len;i++){eData=that._elements[i];if(!eData.filtered&&!eData.selected!=selected){that.setSelected(eData,!selected,true);_transferedOptions.push(eData.optionElement[0]);}}
that._updateGroupElements(gData);that._widget._updateHeaders();that._bufferedMode(false);that._widget._triggerUIEvent(EVENT_CHANGE,{optionElements:_transferedOptions,selected:!selected});}
return false;})).append(labelCount);var fnToggle,groupIcon=(grpElement)?grpElement.attr('data-group-icon'):null;if(this._widget.options.collapsableGroups){var collapseIconAttr=(grpElement)?grpElement.attr('data-collapse-icon'):null,grpCollapseIcon=(collapseIconAttr)?'ui-icon '+collapseIconAttr:'ui-icon ui-icon-triangle-1-s';var h=$('<span></span>').addClass('ui-icon collapse-handle').attr('data-localekey','collapseGroup').attr('title',this._widget._t('collapseGroup')).addClass(grpCollapseIcon).mousedown(function(e){e.stopPropagation();}).click(function(e){e.preventDefault();e.stopPropagation();fnToggle(grpElement);return false;}).prependTo(e.addClass('group-element-collapsable'));fnToggle=function(grpElement){var gDataDst=getLocalData()[selected?'selected':'available'],collapseIconAttr=(grpElement)?grpElement.attr('data-collapse-icon'):null,expandIconAttr=(grpElement)?grpElement.attr('data-expand-icon'):null,collapseIcon=(collapseIconAttr)?'ui-icon '+collapseIconAttr:'ui-icon ui-icon-triangle-1-s',expandIcon=(expandIconAttr)?'ui-icon '+expandIconAttr:'ui-icon ui-icon-triangle-1-e';gDataDst.collapsed=!gDataDst.collapsed;gDataDst.listContainer.slideToggle();h.removeClass(gDataDst.collapsed?collapseIcon:expandIcon).addClass(gDataDst.collapsed?expandIcon:collapseIcon);};}else{if(groupIcon){$('<span></span>').addClass('collapse-handle '+groupIcon).css('cursor','default').prependTo(e.addClass('group-element-collapsable'));}}
return $('<div></div>').data('fnUpdateCount',fnUpdateCount).data('fnToggle',fnToggle||$.noop).append(e);},_createGroupContainerElement:function(grpElement,optGroup,selected){var that=this;var e=$('<div></div>');var _received_index;if(this._widget.options.sortable&&selected){e.sortable({tolerance:"pointer",appendTo:this._widget._elementWrapper,connectWith:this._widget._lists['available'].attr('id'),scope:this._widget.scope,helper:'clone',receive:function(evt,ui){var e=that._elements[_received_index=ui.item.data('element-index')];e.selected=true;e.optionElement.prop('selected',true);e.listElement.removeClass('ui-state-active');},stop:function(evt,ui){var e;if(_received_index){e=that._elements[_received_index];_received_index=undefined;ui.item.replaceWith(e.listElement.addClass('ui-state-highlight option-selected'));that._widget._updateHeaders();that._widget._triggerUIEvent(EVENT_CHANGE,{optionElements:[e.optionElement[0]],selected:true});}else{e=that._elements[ui.item.data('element-index')];if(e&&!e.selected){that._bufferedMode(true);that._appendToList(e);that._bufferedMode(false);}}
if(e)that._reorderSelected(e.optionGroup);},revert:true});}
if(this._selectionMode){$(e).on(this._selectionMode,'div.option-element',function(){var eData=that._elements[$(this).data('element-index')];eData.listElement.removeClass('ui-state-hover');that.setSelected(eData,!selected);});}
return e;},_createElement:function(optElement,optGroup){var o=this._widget.options.optionRenderer?this._widget.options.optionRenderer(optElement,optGroup):$('<div></div>').text(optElement.text());var optIcon=optElement.attr("data-option-icon");var e=$('<div></div>').append(o).addClass('ui-state-default option-element').attr("unselectable","on").data('element-index',-1).hover(function(){if(optElement.prop('selected'))$(this).removeClass('ui-state-highlight');$(this).addClass('ui-state-hover');},function(){$(this).removeClass('ui-state-hover');if(optElement.prop('selected'))$(this).addClass('ui-state-highlight');});if(this._widget.options.selectionMode.indexOf('d&d')>-1){var that=this;e.draggable({addClasses:false,cancel:(this._widget.options.sortable?'.option-selected, ':'')+'.ui-state-disabled',appendTo:this._widget._elementWrapper,scope:this._widget.scope,start:function(evt,ui){$(this).addClass('ui-state-disabled ui-state-active');ui.helper.width($(this).width()).height($(this).height());},stop:function(evt,ui){$(this).removeClass('ui-state-disabled ui-state-active');},helper:'clone',revert:'invalid',zIndex:99999,disabled:optElement.prop('disabled')});if(optElement.prop('disabled')){e.addClass('ui-state-disabled');}
if(this._widget.options.sortable){e.draggable('option','connectToSortable',this._groups.get(optGroup)['selected'].listContainer);}}else if(optElement.prop('disabled')){e[(optElement.prop('disabled')?"add":"remove")+"Class"]('ui-state-disabled');}
if(optIcon){e.addClass('grouped-option').prepend($('<span></span>').addClass('ui-icon '+optIcon));}
return e;},_isOptionCollapsed:function(eData){return this._groups.get(eData.optionGroup)[eData.selected?'selected':'available'].collapsed;},_updateGroupElements:function(gData){if(gData){gData['selected'].count=0;gData['available'].count=0;for(var i=gData.startIndex,len=gData.startIndex+gData.count;i<len;i++){gData[this._elements[i].selected?'selected':'available'].count++;}
gData['selected'].listElement.data('fnUpdateCount')();gData['available'].listElement.data('fnUpdateCount')();}else{this._groups.each(function(k,gData,that){that._updateGroupElements(gData);},this);}},_appendToList:function(eData){var that=this;var gData=this._groups.get(eData.optionGroup);var gDataDst=gData[eData.selected?'selected':'available'];if((eData.optionGroup!=this._widget.options.defaultGroupName)||this._widget.options.showDefaultGroupHeader){gDataDst.listElement.show();}
if(gDataDst.collapsed){gDataDst.listElement.data('fnToggle')();}else{gDataDst.listContainer.show();}
var insertIndex=eData.index-1;while((insertIndex>=gData.startIndex)&&(this._elements[insertIndex].selected!=eData.selected)){insertIndex--;}
if(insertIndex<gData.startIndex){gDataDst.listContainer.prepend(eData.listElement);}else{var prev=this._elements[insertIndex].listElement;if(prev.parent().hasClass('ui-effects-wrapper')){prev=prev.parent();}
eData.listElement.insertAfter(prev);}
eData.listElement[(eData.selected?'add':'remove')+'Class']('ui-state-highlight option-selected');if((eData.selected||!eData.filtered)&&!this._isOptionCollapsed(eData)&&this._moveEffect&&this._moveEffect.fn){eData.listElement.hide().show(this._moveEffect.fn,this._moveEffect.options,this._moveEffect.speed);}else if(eData.filtered){eData.listElement.hide();}},_reorderSelected:function(optGroup){var e=this._elements;var g=this._groups.get(optGroup);$.each(e,function(key,value){if(e[key].selected==true){e[key].listElement.find('div').prepend('<span class="ui-corner-all ui-icon ui-icon-minus" style="float: right"></span>');}else if(e[key].selected==false){e[key].listElement.find('div').prepend('<span class="ui-corner-all ui-icon ui-icon-plus" style="float: right"></span>');}});var container=g.groupElement?g.groupElement:this._widget.element;var prevElement;$('.option-element',g['selected'].listContainer).each(function(){var currElement=e[$(this).data('element-index')].optionElement;if(!prevElement){container.prepend(currElement);}else{currElement.insertAfter(prevElement);}
prevElement=currElement;});},_bufferedMode:function(enabled){if(enabled){this._oldMoveEffect=this._moveEffect;this._moveEffect=null;this._widget._lists['selected'].data('scrollTop',this._widget._lists['selected'].scrollTop());this._widget._lists['available'].data('scrollTop',this._widget._lists['available'].scrollTop());this._listContainers['selected'].detach();this._listContainers['available'].detach();}else{this._widget._lists['selected'].append(this._listContainers['selected']).scrollTop(this._widget._lists['selected'].data('scrollTop')||0);this._widget._lists['available'].append(this._listContainers['available']).scrollTop(this._widget._lists['available'].data('scrollTop')||0);this._moveEffect=this._oldMoveEffect;delete this._oldMoveEffect;}},reset:function(destroy){this._groups.clear();this._listContainers['selected'].empty();this._listContainers['available'].empty();if(destroy){for(var i=0,e=this._elements,len=e.length;i<len;i++){e[i].optionElement.removeData('element-index');}
delete this._elements;delete this._groups;delete this._listContainers;}else{this._elements=[];this.prepareGroup();this._groups.setComparator(this.getComparator());}},cleanup:function(){var p=this._widget.element[0];var _groupsRemoved=[];this._groups.each(function(g,v){if(v.groupElement&&!$.contains(p,v.groupElement[0])){_groupsRemoved.push(g);}});for(var i=0,eData;i<this._elements.length;i++){eData=this._elements[i];if(!$.contains(p,eData.optionElement[0])||($.inArray(eData.optionGroup,_groupsRemoved)>-1)){this._elements.splice(i--,1)[0].listElement.remove();}}
for(var i=0,len=_groupsRemoved.length;i<len;i++){this._groups.remove(_groupsRemoved[i]);}
this.prepareGroup();},getComparator:function(){return this._widget.options.sortMethod?typeof this._widget.options.sortMethod=='function'?this._widget.options.sortMethod:ItemComparators[this._widget.options.sortMethod]:null;},prepareGroup:function(grpElement,optGroup){optGroup=optGroup||DEF_OPTGROUP;if(!this._groups.containsKey(optGroup)){this._groups.put(optGroup,{startIndex:-1,count:0,'selected':{collapsed:false,count:0,listElement:this._createGroupElement(grpElement,optGroup,true),listContainer:this._createGroupContainerElement(grpElement,optGroup,true)},'available':{collapsed:false,count:0,listElement:this._createGroupElement(grpElement,optGroup,false),listContainer:this._createGroupContainerElement(grpElement,optGroup,false)},groupElement:grpElement,optionGroup:optGroup});}},prepareOption:function(optElement,optGroup){var e;if(optElement.data('element-index')===undefined){optGroup=optGroup||DEF_OPTGROUP;this._elements.push(e={index:-1,selected:false,filtered:false,listElement:this._createElement(optElement,optGroup),optionElement:optElement,optionGroup:optGroup});}else{this._elements[optElement.data('element-index')].listElement[(optElement.prop('disabled')?"add":"remove")+"Class"]('ui-state-disabled');}},reIndex:function(){var comparator=this.getComparator();if(comparator){var _groups=this._groups;this._elements.sort(function(a,b){var ga=_groups.get(a.optionGroup).groupElement;var gb=_groups.get(b.optionGroup).groupElement;var g=comparator(ga?ga.attr('label'):DEF_OPTGROUP,gb?gb.attr('label'):DEF_OPTGROUP);if(g!=0)return g;else return comparator(a.optionElement.text(),b.optionElement.text());});}
this._bufferedMode(true);this._groups.each(function(g,v,l,showDefGroupName){if(!v['available'].listContainer.parents('.multiselect-element-wrapper').length){if(v.groupElement){v.groupElement.data('option-group',g);}
var wrapper_selected=$('<div></div>').addClass('multiselect-element-wrapper').data('option-group',g);var wrapper_available=$('<div></div>').addClass('multiselect-element-wrapper').data('option-group',g);wrapper_selected.append(v.selected.listElement.hide());if(g!=DEF_OPTGROUP||(g==DEF_OPTGROUP&&showDefGroupName)){wrapper_available.append(v['available'].listElement.show());}
wrapper_selected.append(v['selected'].listContainer);wrapper_available.append(v['available'].listContainer);l['selected'].append(wrapper_selected);l['available'].append(wrapper_available);}
v.count=0;},this._listContainers,this._widget.options.showDefaultGroupHeader);for(var i=0,eData,gData,len=this._elements.length;i<len;i++){eData=this._elements[i];gData=this._groups.get(eData.optionGroup);if(gData.startIndex==-1||gData.startIndex>=i){gData.startIndex=i;gData.count=1;}else{gData.count++;}
eData.listElement.data('element-index',eData.index=i);if(eData.optionElement.data('element-index')==undefined||eData.selected!=eData.optionElement.prop('selected')){eData.selected=eData.optionElement.prop('selected');eData.optionElement.data('element-index',i);this._appendToList(eData);}}
this._updateGroupElements();this._widget._updateHeaders();this._groups.each(function(g,v,t){t._reorderSelected(g);},this);this._bufferedMode(false);},filter:function(term,silent){if(term&&!silent){var ui={term:term};if(this._widget._triggerUIEvent(EVENT_SEARCH,ui)){term=ui.term;}else{return;}}
this._bufferedMode(true);var filterSelected=this._widget.options.filterSelected;var filterFn=this._widget.options.searchFilter||function(term,opt){return opt.innerHTML.toLowerCase().indexOf(term)>-1;};term=(this._widget.options.searchPreFilter||function(term){return term?(term+"").toLowerCase():false;})(term);for(var i=0,eData,len=this._elements.length,filtered;i<len;i++){eData=this._elements[i];filtered=!(!term||filterFn(term,eData.optionElement[0]));if((!eData.selected||filterSelected)&&(eData.filtered!=filtered)){eData.listElement[filtered?'hide':'show']();eData.filtered=filtered;}else if(eData.selected){eData.filtered=false;}}
this._widget._updateHeaders();this._bufferedMode(false);},getSelectionInfo:function(){var info={'selected':{'total':0,'count':0,'filtered':0},'available':{'total':0,'count':0,'filtered':0}};for(var i=0,len=this._elements.length;i<len;i++){var eData=this._elements[i];info[eData.selected?'selected':'available'][eData.filtered?'filtered':'count']++;info[eData.selected?'selected':'available'].total++;}
return info;},setSelected:function(eData,selected,silent){if(eData.optionElement.attr('disabled')&&selected){return;}
if(!eData.selected){eData.listElement.find('span').remove();eData.listElement.find('div').prepend('<span class="ui-corner-all ui-icon ui-icon-minus" style="float: right"></span>');}
else if(eData.selected){eData.listElement.find('span').remove();eData.listElement.find('div').prepend('<span class="ui-corner-all ui-icon ui-icon-plus" style="float: right"></span>');}
eData.optionElement.prop('selected',eData.selected=selected);this._appendToList(eData);if(!silent){if(this._widget.options.sortable&&selected){this._reorderSelected(eData.optionGroup);}
this._updateGroupElements(this._groups.get(eData.optionGroup));this._widget._updateHeaders();this._widget._triggerUIEvent(EVENT_CHANGE,{optionElements:[eData.optionElement[0]],selected:selected});}},setSelectedAll:function(selected){var _transferedOptions=[];var _modifiedGroups={};this._bufferedMode(true);for(var i=0,eData,len=this._elements.length;i<len;i++){eData=this._elements[i];if(!((eData.selected==selected)||(eData.optionElement.attr('disabled')||(selected&&(eData.filtered||eData.selected))))){this.setSelected(eData,selected,true);_transferedOptions.push(eData.optionElement[0]);_modifiedGroups[eData.optionGroup]=true;}}
if(this._widget.options.sortable&&selected){var that=this;$.each(_modifiedGroups,function(g){that._reorderSelected(g);});}
this._updateGroupElements();this._widget._updateHeaders();this._bufferedMode(false);this._widget._triggerUIEvent(EVENT_CHANGE,{optionElements:_transferedOptions,selected:selected});}};function _(p){var locale=$.uix.multiselect.i18n[p.locale]?p.locale:'';var i18n=$.uix.multiselect.i18n[locale];var plural=p.plural||0;var data=p.data||{};var t;if(plural===2&&i18n[p.key+'_plural_two']){t=i18n[p.key+'_plural_two'];}else if((plural===2||plural===3)&&i18n[p.key+'_plural_few']){t=i18n[p.key+'_plural_few']}else if(plural>1&&i18n[p.key+'_plural']){t=i18n[p.key+'_plural'];}else if(plural===0&&i18n[p.key+'_nil']){t=i18n[p.key+'_nil'];}else{t=i18n[p.key]||'';}
return t.replace(/\{([^\}]+)\}/g,function(m,n){return data[n];});};$.uix.multiselect.i18n={'':{itemsSelected_nil:'no selected option',itemsSelected:'{count} selected option',itemsSelected_plural:'{count} selected options',itemsAvailable_nil:'no item available',itemsAvailable:'{count} available option',itemsAvailable_plural:'{count} available options',itemsFiltered_nil:'no option filtered',itemsFiltered:'{count} option filtered',itemsFiltered_plural:'{count} options filtered',selectAll:'Select All',deselectAll:'Deselect All',search:'Search Options',collapseGroup:'Collapse Group',expandGroup:'Expand Group',selectAllGroup:'Select All Group',deselectAllGroup:'Deselect All Group'}};})(jQuery,window);
